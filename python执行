# ============== åŸå§‹ç‰ˆåŠä¿®æ­£ç‰ˆ ==============
import requests
import json
import time
import hashlib
import hmac
from datetime import datetime
import pandas as pd
import os

# ================= é…ç½®åŒº =================
APP_KEY = "7594740370877974066"
APP_SECRET = "17c5ae02-19d6-4a2d-aa41-f20901858c85"
METHOD = "buyin.instituteOrderMCN"
ACCESS_TOKEN = "1epv9xduwc1lp8ursirb96a7qc7262657484790268194-11"

# ================= 1. æ—¶é—´è®¾ç½® =================
print("â³ è¯·è®¾ç½®æŸ¥è¯¢æ—¶é—´èŒƒå›´")
print("-" * 30)

start_input = input("ğŸ‘‰ è¯·è¾“å…¥ã€å¼€å§‹ã€‘æ—¶é—´ (æ ¼å¼ 2026-01-01 00:00:00): ").strip()
if not start_input:
    start_input = "2026-01-02 15:04:05"
    print(f"âš ï¸ æœªè¾“å…¥ï¼Œä½¿ç”¨é»˜è®¤: {start_input}")

now = datetime.now()
end_input = now.strftime("%Y-%m-%d %H:%M:%S")

print(f"âœ… é”å®šå¼€å§‹æ—¶é—´: {start_input}")
print(f"âœ… é”å®šç»“æŸæ—¶é—´: {end_input}")
print("-" * 30)

# ================= 2. æ ¸å¿ƒæŠ“å–é€»è¾‘ =================
current_cursor = "0"
page_size = "200"
all_orders = []
page_count = 1

print(f"ğŸš€ å¯åŠ¨æŠ“å– (é¡µå®¹é‡: {page_size})")

while True:
    print(f"\rğŸš€ æ­£åœ¨æŠ“å–ç¬¬ {page_count} é¡µ (å·²è·å– {len(all_orders)} æ¡)...", end="")

    body_data = {
        "cursor": str(current_cursor),
        "end_time": end_input,
        "size": page_size,
        "start_time": start_input,
        "time_type": "pay"
    }
    param_json = json.dumps(body_data, separators=(',', ':'), ensure_ascii=False)

    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    sign_str = f"app_key{APP_KEY}method{METHOD}param_json{param_json}timestamp{timestamp}v2"
    sign_pattern = APP_SECRET + sign_str + APP_SECRET
    sign = hmac.new(APP_SECRET.encode('utf-8'), sign_pattern.encode('utf-8'), hashlib.sha256).hexdigest()

    url = "https://openapi-fxg.jinritemai.com/buyin/instituteOrderMCN"
    params = {
        "method": METHOD, "app_key": APP_KEY, "access_token": ACCESS_TOKEN,
        "timestamp": timestamp, "v": "2", "sign": sign, "sign_method": "hmac-sha256"
    }

    try:
        response = requests.post(url, params=params, data=param_json, headers={'Content-Type': 'application/json'})
        result = response.json()
    except Exception as e:
        print(f"\nâŒ ç¬¬ {page_count} é¡µè¯·æ±‚å¤±è´¥: {e}")
        break

    data_part = result.get("data", {})
    if data_part is None: data_part = {}
    
    order_list = data_part.get("orders") or data_part.get("list") or []
    count = len(order_list)

    if count > 0:
        all_orders.extend(order_list)
        new_cursor = data_part.get("cursor")
        if new_cursor and str(new_cursor) != str(current_cursor):
            current_cursor = str(new_cursor)
            page_count += 1
            time.sleep(0.2) 
        else:
            print(f"\nğŸ æœåŠ¡å™¨æœªè¿”å›æ–°é¡µé¢æ¸¸æ ‡ï¼ŒæŠ“å–ç»“æŸã€‚")
            break
    else:
        print(f"\nâš ï¸ ç¬¬ {page_count} é¡µæ•°æ®ä¸ºç©ºï¼Œåœæ­¢æŠ“å–ã€‚")
        break

# ================= 3. æ•°æ®å¤„ç†ä¸å¯¼å‡º (åŒç‰ˆæœ¬) =================
print(f"\n\nğŸ‰ æŠ“å–å®Œæˆï¼æ€»å…± {len(all_orders)} æ¡ã€‚æ­£åœ¨åˆ†åˆ«ç”Ÿæˆä¸¤ä»½è¡¨æ ¼...")

if len(all_orders) > 0:
    
    # ã€é€šç”¨å¤„ç†ã€‘å…ˆæŠŠæ‰€æœ‰IDè½¬ä¸ºå­—ç¬¦ä¸² (é¿å…ä¸¤ä»½è¡¨æ ¼éƒ½å‡ºç°ç§‘å­¦è®¡æ•°æ³•)
    for order in all_orders:
        if 'media_id' in order and order['media_id'] is not None:
            order['media_id'] = str(order['media_id'])
    
    # ---------------------------------------------------------
    # ğŸ“‚ ç‰ˆæœ¬ä¸€ï¼šåŸå§‹ç‰ˆ (ä¿ç•™è‹±æ–‡ï¼ŒåŸæ±åŸå‘³ï¼ŒæŒ‡å®šé¡ºåº)
    # ---------------------------------------------------------
    print("ğŸ”§ æ­£åœ¨ç”Ÿæˆ [åŸå§‹ç‰ˆ]...")
    df_raw = pd.DataFrame(all_orders)
    
    # 1. åŸå§‹ç‰ˆè¦æ±‚çš„å­—æ®µé¡ºåº
    raw_columns_order = [
        'order_id', 'product_id', 'product_name', 'product_img', 'author_account',
        'author_openid', 'shop_name', 'total_pay_amount', 'commission_rate',
        'estimated_commission', 'real_commission', 'flow_point', 'app',
        'update_time', 'pay_success_time', 'settle_time', 'pay_goods_amount',
        'settled_goods_amount', 'shop_id', 'shop_estimated_commission',
        'shop_real_commission', 'alliance_split_rate', 'tech_service_fee_rate',
        'estimated_tech_service_fee', 'settled_tech_service_fee',
        'estimated_institution_commission', 'institution_commission', 'item_num',
        'refund_time', 'estimated_total_commission', 'ads_estimated_commission',
        'ads_real_commission', 'author_short_id', 'ads_promotion_rate', 'extra',
        'author_buyin_id', 'media_type', 'media_id', 'pay_subsidy',
        'platform_subsidy', 'author_subsidy', 'estimated_user_stepped_commission',
        'estimated_inst_stepped_commission', 'settle_user_stepped_commission',
        'settle_inst_stepped_commission', 'is_stepped_plan'
    ]

    # 2. è¡¥å…¨ç¼ºå¤±åˆ— & æ’åº
    for col in raw_columns_order:
        if col not in df_raw.columns:
            df_raw[col] = "" # ç¼ºå¤±è¡¥ç©º
    df_raw = df_raw[raw_columns_order] # å¼ºåˆ¶æ’åº

    # ---------------------------------------------------------
    # ğŸ“‚ ç‰ˆæœ¬äºŒï¼šä¿®æ­£ç‰ˆ (æ•°å€¼è®¡ç®— + æ˜ å°„ + æ±‰åŒ–)
    # ---------------------------------------------------------
    print("ğŸ”§ æ­£åœ¨ç”Ÿæˆ [ä¿®æ­£ç‰ˆ]...")
    # å¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œä»¥å…ä¿®æ”¹å½±å“åˆ°ä¸Šé¢çš„åŸå§‹ç‰ˆ
    df_revised = df_raw.copy()

    # 1. å®šä¹‰æ˜ å°„å…³ç³» (æ–°å¢éœ€æ±‚)
    flow_point_map = {
        'PAY_SUCC': 'è®¢å•ä»˜æ¬¾',
        'REFUND': 'è®¢å•é€€è´§é€€æ¬¾',
        'SETTLE': 'è®¢å•ç»“ç®—',
        'CONFIRM': 'è®¢å•æ”¶è´§'
    }
    media_type_map = {
        'shop_list': 'æ©±çª—',
        'video': 'è§†é¢‘',
        'live': 'ç›´æ’­',
        'others': 'å…¶ä»–'
    }

    # 2. æ‰§è¡Œæ˜ å°„ (ä½¿ç”¨ mapï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆ™ä¿ç•™åŸå€¼)
    if 'flow_point' in df_revised.columns:
        df_revised['flow_point'] = df_revised['flow_point'].map(flow_point_map).fillna(df_revised['flow_point'])
    
    if 'media_type' in df_revised.columns:
        df_revised['media_type'] = df_revised['media_type'].map(media_type_map).fillna(df_revised['media_type'])

    # 3. æ•°å€¼è®¡ç®— (åˆ†->å…ƒï¼Œä¸‡åˆ†ä½->ç™¾åˆ†æ¯”)
    money_cols = [
        'pay_goods_amount', 'estimated_total_commission', 'estimated_commission', 
        'estimated_institution_commission', 'settled_goods_amount', 'real_commission', 
        'institution_commission', 'estimated_tech_service_fee', 'settled_tech_service_fee', 
        'estimated_user_stepped_commission', 'estimated_inst_stepped_commission', 
        'settle_user_stepped_commission', 'settle_inst_stepped_commission', 
        'pay_subsidy', 'platform_subsidy', 'author_subsidy', 'total_pay_amount',
        'shop_estimated_commission', 'shop_real_commission' 
    ]
    rate_cols = ['commission_rate', 'alliance_split_rate', 'tech_service_fee_rate']

    for col in money_cols:
        if col in df_revised.columns:
            # å…ˆè½¬æˆæ•°å­—ç±»å‹ï¼Œæ— æ³•è½¬çš„å˜NaN (errors='coerce')
            df_revised[col] = pd.to_numeric(df_revised[col], errors='coerce').fillna(0)
            df_revised[col] = (df_revised[col] / 100).round(2)

    for col in rate_cols:
        if col in df_revised.columns:
            df_revised[col] = pd.to_numeric(df_revised[col], errors='coerce').fillna(0)
            # ä½¿ç”¨ apply å®ç°ç™¾åˆ†æ¯”æ ¼å¼åŒ–
            df_revised[col] = df_revised[col].apply(lambda x: f"{int(x/100)}%")

    # 4. æ±‰åŒ–ä¸é‡æ’
    rename_map = {
        'order_id': 'è®¢å•id', 'product_id': 'å•†å“id', 'product_name': 'å•†å“åç§°',
        'flow_point': 'è®¢å•çŠ¶æ€', 'author_account': 'è¾¾äººæ˜µç§°', 'author_short_id': 'è¾¾äººæŠ–éŸ³å·',
        'pay_goods_amount': 'æˆäº¤é‡‘é¢', 'commission_rate': 'ä½£é‡‘ç‡', 'estimated_total_commission': 'æ€»ä½£é‡‘æ”¶å…¥',
        'estimated_commission': 'é¢„ä¼°ä½£é‡‘æ”¶å…¥-è¾¾äºº', 'estimated_institution_commission': 'é¢„ä¼°ä½£é‡‘æ”¶å…¥-æœºæ„',
        'settled_goods_amount': 'ç»“ç®—é‡‘é¢', 'real_commission': 'ç»“ç®—ä½£é‡‘æ”¶å…¥-è¾¾äºº',
        'institution_commission': 'ç»“ç®—ä½£é‡‘æ”¶å…¥-æœºæ„', 'pay_success_time': 'è®¢å•æ”¯ä»˜æ—¶é—´',
        'settle_time': 'è®¢å•ç»“ç®—æ—¶é—´', 'alliance_split_rate': 'åˆ†æˆæ¯”ä¾‹',
        'estimated_tech_service_fee': 'é¢„ä¼°æŠ€æœ¯æœåŠ¡è´¹', 'settled_tech_service_fee': 'ç»“ç®—æŠ€æœ¯æœåŠ¡è´¹',
        'shop_id': 'åº—é“ºid', 'shop_name': 'åº—é“ºåç§°', 'item_num': 'å•†å“æ•°é‡',
        'is_stepped_plan': 'æ˜¯å¦é˜¶æ¢¯ä½£é‡‘', 'estimated_user_stepped_commission': 'è¾¾äººé¢„ä¼°å¥–åŠ±ä½£é‡‘æ”¶å…¥',
        'estimated_inst_stepped_commission': 'æœºæ„é¢„ä¼°å¥–åŠ±ä½£é‡‘æ”¶å…¥',
        'settle_user_stepped_commission': 'è¾¾äººç»“ç®—å¥–åŠ±ä½£é‡‘æ”¶å…¥',
        'settle_inst_stepped_commission': 'æœºæ„ç»“ç®—å¥–åŠ±ä½£é‡‘æ”¶å…¥', 'pay_subsidy': 'æ”¯ä»˜è¡¥è´´',
        'platform_subsidy': 'å¹³å°è¡¥è´´', 'author_subsidy': 'è¾¾äººè¡¥è´´', 'media_type': 'æµé‡æ¥æº'
    }
    df_revised.rename(columns=rename_map, inplace=True)

    # ä¿®æ­£ç‰ˆè¦æ±‚çš„æœ€ç»ˆé¡ºåº
    revised_columns_order = [
        'è®¢å•id', 'å•†å“id', 'å•†å“åç§°', 'è®¢å•çŠ¶æ€', 'è¶…æ—¶æœªç»“ç®—åŸå› ',
        'è¾¾äººæ˜µç§°', 'è¾¾äººæŠ–éŸ³å·', 'æˆäº¤é‡‘é¢', 'ä½£é‡‘ç‡', 'æ€»ä½£é‡‘æ”¶å…¥',
        'é¢„ä¼°ä½£é‡‘æ”¶å…¥-è¾¾äºº', 'é¢„ä¼°ä½£é‡‘æ”¶å…¥-æœºæ„', 'ç»“ç®—é‡‘é¢', 'ç»“ç®—ä½£é‡‘æ”¶å…¥-è¾¾äºº',
        'ç»“ç®—ä½£é‡‘æ”¶å…¥-æœºæ„', 'è®¢å•æ”¯ä»˜æ—¶é—´', 'è®¢å•æ”¶è´§æ—¶é—´', 'è®¢å•ç»“ç®—æ—¶é—´',
        'åˆ†æˆæ¯”ä¾‹', 'é¢„ä¼°æŠ€æœ¯æœåŠ¡è´¹', 'ç»“ç®—æŠ€æœ¯æœåŠ¡è´¹', 'æ–°è€è´¦æˆ·',
        'å•†å“æ¥æº', 'å°¾æ¬¾æ”¯ä»˜æ—¶é—´', 'å®šé‡‘é‡‘é¢', 'åº—é“ºid', 'åº—é“ºåç§°',
        'å•†å“æ•°é‡', 'å®‰å¿ƒè´­', 'ä½£é‡‘å‘ç¥¨', 'å†»ç»“æ¯”ä¾‹', 'æ˜¯å¦é˜¶æ¢¯ä½£é‡‘',
        'é—¨æ§›é”€é‡', 'åŸºç¡€ä½£é‡‘ç‡', 'å‡ä½£ä½£é‡‘ç‡', 'è¾¾äººé¢„ä¼°å¥–åŠ±ä½£é‡‘æ”¶å…¥',
        'æœºæ„é¢„ä¼°å¥–åŠ±ä½£é‡‘æ”¶å…¥', 'è¾¾äººç»“ç®—å¥–åŠ±ä½£é‡‘æ”¶å…¥', 'æœºæ„ç»“ç®—å¥–åŠ±ä½£é‡‘æ”¶å…¥',
        'é˜¶æ¢¯è®¡åˆ’ID', 'æ”¯ä»˜è¡¥è´´', 'å¹³å°è¡¥è´´', 'è¾¾äººè¡¥è´´', 'è¿è´¹', 'ç¨è´¹',
        'è¿è´¹è¡¥è´´', 'åˆ†é”€æ¥æº', 'è¥é”€æ´»åŠ¨id', 'æ¨å¹¿è´¹ç‡', 'æ¨å¹¿æŠ€æœ¯æœåŠ¡è´¹',
        'é¢„ä¼°æ¨å¹¿è´¹æ”¶å…¥', 'ç»“ç®—æ¨å¹¿è´¹æ”¶å…¥', 'ä½£é‡‘ç±»å‹', 'è®¢å•æ¥æº',
        'æµé‡ç»†åˆ†æ¥æº', 'æµé‡æ¥æº', 'è®¢å•ç±»å‹'
    ]
    
    for col in revised_columns_order:
        if col not in df_revised.columns:
            df_revised[col] = ""
    df_revised = df_revised[revised_columns_order]

    # ---------------------------------------------------------
    # ğŸ’¾ ä¿å­˜åŒæ–‡ä»¶
    # ---------------------------------------------------------
    downloads_path = os.path.join(os.path.expanduser("~"), 'Downloads')Â  
    today_str = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    # æ–‡ä»¶ 1ï¼šåŸå§‹ç‰ˆ
    file_raw = f'MCN è®¢å•_{today_str}_{len(all_orders)}æ¡_åŸå§‹ç‰ˆ.xlsx'
    path_raw = os.path.join(downloads_path, file_raw)
    df_raw.to_excel(path_raw, index=False)
    
    # æ–‡ä»¶ 2ï¼šä¿®æ­£ç‰ˆ
    file_revised = f'MCN è®¢å•_{today_str}_{len(all_orders)}æ¡_ä¿®æ­£ç‰ˆ.xlsx'
    path_revised = os.path.join(downloads_path, file_revised)
    df_revised.to_excel(path_revised, index=False)
    
    print(f"\nâœ… å…¨éƒ¨å¤„ç†å®Œæ¯•ï¼å·²åœ¨ã€ä¸‹è½½ã€‘æ–‡ä»¶å¤¹ç”Ÿæˆ 2 ä¸ªæ–‡ä»¶ï¼š")
    print(f"ğŸ“„ 1. {file_raw} (åŒ…å«æ‰€æœ‰è‹±æ–‡å­—æ®µï¼Œé¡ºåºå·²è°ƒæ•´)")
    print(f"ğŸ“„ 2. {file_revised} (ä¸­æ–‡è¡¨å¤´ï¼Œé‡‘é¢/çŠ¶æ€/æµé‡æ¥æºå·²ä¿®æ­£)")
else:
    print("âš ï¸ æœªæŠ“å–åˆ°æ•°æ®ã€‚")
